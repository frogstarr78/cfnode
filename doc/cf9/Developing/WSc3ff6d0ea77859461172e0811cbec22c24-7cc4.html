<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0022)http://help.adobe.com/ -->
<html lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="lang" content="en-us" />
    <meta name="area" content="livedocs" />
    <title>Adobe&#160;ColdFusion&#160;9 * Locking code with cflock</title>
    <link rel="shortcut icon" href="images/ColdFusionLinkIndicator.png" />
    <meta name="book" content="Developing&#160;ColdFusion 9 Applications" />
    <meta name="product" content="ColdFusion" />
    <meta name="keywords" content="" /><!--<PageMap><DataObject type="document"><Attribute name="product" value="ColdFusion"></Attribute><Attribute name="book" value="Developing&#160;ColdFusion 9 Applications"></Attribute><Attribute name="keywords" value=""></Attribute></DataObject></PageMap>-->
    
    <script type="text/javascript" language="Javascript" charset="UTF-8"><!--[CDATA[
        var currentTreeNode = "WSc3ff6d0ea77859461172e0811cbec22c24-7cc4.html";
    document.cookie = "topicId=" + "WSc3ff6d0ea77859461172e0811cbec22c24-7cc4.html";
// ]]--></script>
<script src="terms.js" type="text/javascript" language="Javascript" charset="UTF-8">...</script> <script src="help.js" type="text/javascript" language="Javascript" charset="UTF-8">...</script>  <script src="utilities.js" type="text/javascript" language="Javascript" charset="UTF-8">...</script> <script src="event.js" type="text/javascript" language="Javascript" charset="UTF-8">...</script> <script src="treeview.js" type="text/javascript" language="Javascript" charset="UTF-8">...</script> <script src="toc.js" language="Javascript" type="text/javascript" charset="UTF-8">..</script> <script src="swfobject.js" language="Javascript" type="text/javascript" charset="UTF-8">..</script>  <script src="booklist.js" language="Javascript" type="text/javascript" charset="UTF-8">..</script>
<script type="text/javascript">
<!--[CDATA[
var topictype = "topic";
var headId = document.getElementsByTagName("head")[0];         
if (use_ie_6_behavior) {
  var linkId = document.createElement("link");
  linkId.href = "content-ie6.css";
  linkId.rel = "stylesheet";
  linkId.type = "text/css";
  headId.appendChild(linkId);
}
function initRoboHelpDOM() {
  if (use_chm_behavior) {
    hideElement("search");
  }
  if (use_robohelp_behavior) {
    hideElement("search");
    hideElement("productmenu");
    //hideElement("notyourversion");
  }
  if(!use_chc_behavior) {
    //document.getElementById("notyourversion").style.display = "inline";;
  }
}
var dirname = location.pathname.match( /.*\// );    
function setSearchUserPref(){
  if ( document.cookie.indexOf( "ah_searchpref" ) > -1 ) {
    if ( document.cookie.indexOf( dirname ) > 0 ) {
      document.search.gsa.checked = true ;
    }else{
      document.search.gsa.checked = false ;            
    }
  }
}
YAHOO.util.Event.onDOMReady(initRoboHelpDOM);
YAHOO.util.Event.onDOMReady(setSearchUserPref);
// ]]-->
</script>

<!-- ********************************** -->
<!-- START: ForeSee survey code in: /ssi/globalheader.ssi -->

<script type="text/javascript">
<!-- 
// Enable the survey for only English, German and Japanese
var agt=navigator.userAgent.toLowerCase();
if ( agt.indexOf("community help client") == -1 ){
    if ( document.location.href.indexOf("/en_US/") != -1 ){
        showSurvey();
//    }else if (document.location.href.indexOf("/de_DE/") != -1){
//         var locale="de";
//         showSurvey();
    }else if (document.location.href.indexOf("/ja_JP/") != -1 ){
         var locale="ja";
         showSurvey();
    }	
}

function showSurvey(){
	document.write('<script type="text/javascript" src="/js/foresee/foresee-trigger.js"><\/scr'+'ipt>');
}

// -->
</script>

<!-- END: ForeSee survey code -->
<!-- ******************************** -->




    <link rel="stylesheet" type="text/css" href="tree.css" />
    <link rel="stylesheet" type="text/css" href="content.css" />
    <link rel="stylesheet" type="text/css" href="localeSpecific.css" />
  </head>
  <body id="content_body" onload="window.focus();">
    <a name="top" shape="rect"><!--LeaveCommentHere--></a>
    
    <div id="mnemonic">
      <!--googleoff: index--><div xmlns:adobe="http://www.adobe.com/saxon" class="ColdFusion"><div class="banner"><a href="WSf01dbd23413dda0e-446b5201205757ce2b-8000.html">Adobe&#160;ColdFusion&#160;9</a><span id="notyourversion">|&#160;
                    <a rel="nofollow" href="http://www.adobe.com/support/documentation/en/coldfusion/">Not your version?</a></span></div></div><!--googleon: index-->
    </div>
    
    <div id="searchbar">
<table id="searchbartable">
<tr>
<td colspan="2">
      <!--googleoff: index--><div xmlns:adobe="http://www.adobe.com/saxon"><div id="pdf"><img src="images/PDF.gif" width="16" height="16" /><a title="View Help PDF" href="coldfusion_9_dev.pdf">View Help PDF ( 23MB)</a></div></div><!--googleon: index-->
</td>
</tr>
</table>
    </div>

<!-- BEGIN SEARCH CONTENT -->
<form id="search" name="search" action="search.html" target="_self">
<script type="text/javascript">
<!--[CDATA[
if ( !use_chc_behavior ){
    if (typeof(terms_AHV_SEARCH_CONSTRAINT) != "undefined" && 
        terms_AHV_SEARCH_CONSTRAINT.length > 0 && 
        document.location.href.indexOf(".adobe.com") > 0){
        if ( typeof(terms_SEARCH_THIS_HELP_ONLY) != "undefined" && terms_SEARCH_THIS_HELP_ONLY == "ON" ) {
            document.write('<div id="searchscope"> \
                <input onchange="setAHSearchPref();" \
                class="gsa" \
                name="gsa" \
                id="gsa" \
                type="checkbox" \
                checked="checked" \
                value="1" ><\/input>'); 
                
        // Leave the "Search this help system only" checkbox unckecked
        }else{    
            document.write('<div id="searchscope"> \
                <input onchange="setAHSearchPref();" \
                class="gsa" \
                name="gsa" \
                id="gsa" \
                type="checkbox" \
                value="1" ><\/input>'); 
        }
        document.write('<span class="gsalabel">' + terms_AHV_SEARCH_CONSTRAINT + '<\/span><\/div>'); 
    }
    document.write('<input class="searchinput" \
        name="q" \
        id="q" \
        type="text" \
        maxlength="256" \
        value="' + terms_AHV_SEARCH_BUTTON + '" \
        onclick="clearSearch()"><\/input><input \
        type="button" \
        name="searchbutton" \
        class="searchbutton" \
        onclick="submit()"><\/input>'); 
} 
 
/* 
 * Start Functions 
 */
function clearSearch(){
    if (document.search.q.value == terms_AHV_SEARCH_BUTTON){document.search.q.value = ""}; 
}

// set search preferences
function setAHSearchPref(){
    if (document.search.gsa.checked == 1){
        setAHSearchCookie( dirname );
    }else{
        setAHSearchCookie( "community" );
    }
}

// Set search preferences cookie
function setAHSearchCookie( p ){
    // set cookie ah_searchpref with a value of the document path
    var expire=new Date();
    expire.setDate(expire.getDate()+365); // Cookie expires after 1 year (365 days) 
    document.cookie="ah_searchpref=" +p+ "; expires=" +expire.toGMTString()+ ";";
}

// ]]-->
</script> 
 </form>
<!-- END SEARCH CONTENT -->    



<!-- BEGIN PAGE CONTENT WRAPPER -->
    <div id="page_content_wrapper">
<!-- BEGIN PAGE WRAPPER -->
<table id="page_content_table">
<tr>

<td id="col2">
<!-- BEGIN CONTENT WRAPPER -->
<!-- BEGIN BREADCRUMBS -->

      
      <div id="breadcrumb">
        
<ul class="navigation"><li class="prev"><a accesskey="p" class="prev" href="WSc3ff6d0ea77859461172e0811cbec0c35c-7fdb.html" title="Using server variables"><img src="images/blank.gif" alt="Previous" width="17" height="17" /></a></li><li class="next"><a accesskey="n" class="next" href="WSc3ff6d0ea77859461172e0811cbec22c24-7cb8.html" title="Examples of cflock"><img src="images/blank.gif" alt="Next" width="17" height="17" /></a></li></ul><div class="hierarchy" id="hierarchy"><a href="WSf01dbd23413dda0e-446b5201205757ce2b-8000.html"><b>Home</b></a> / <a href="WSf01dbd23413dda0e-446b5201205757ce2b-8000.html"><b>Developing&#160;ColdFusion 9 Applications</b></a> / <a href="WS8f0cc78011fffa71-ea0996f11cdae56045-8000.html"><b>Developing CFML Applications</b></a> 
      / <a href="WSc3ff6d0ea77859461172e0811cbec22c24-7fd4.html"><b>Using Persistent Data and Locking</b></a> 
     </div>

      </div>
<!-- END BREADCRUMBS -->
      <div id="content_wrapper">
<!-- BEGIN PAGE TITLE -->
        <h1>Locking code with cflock</h1>
<!-- END PAGE TITLE -->
<!-- BEGIN IONCOMMENTCOUNT -->
        <div id="ionCount">
        </div>
<!-- END IONCOMMENTCOUNT -->
<table id="inner_content_table" width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td>
          <div style="border-top:#ccc solid 1px;"><p> </p>
          </div>
<p id="chcPromo" style="display:none;">
<a id="chcLink" href="http://www.adobe.com/support/chc/">
<img id="chcImage" src="http://www.adobe.com/support/chc/GetMoreHelpFeatures.png"/>
</a>
</p>
<script type="text/javascript" language="javascript" charset="utf-8">
<!--
var cfgArray = [];
//cfgArray["Acrobat_10.0_Professional.helpcfg"] = "acrobatpro";
//cfgArray["Acrobat_10.0_Standard.helpcfg"] = "acrobatstd";
cfgArray["Lightroom_3.0.helpcfg"] = "lightroom";
cfgArray["PhotoshopElements_8.0_Win.helpcfg"] = "photoshopelements";
cfgArray["PhotoshopElements_8.0_Mac.helpcfg"] = "photoshopelementsmac";
cfgArray["PremiereElements_8.0_Win.helpcfg"] = "premiereelements";

//cfgArray["AfterEffects_10.0.helpcfg"] = "aftereffects";
//cfgArray["AIR.helpcfg"] = "air";
//cfgArray["ColdFusionBuilder.helpcfg"] = "coldfusion";
//cfgArray["Contribute_6.0.helpcfg"] = "contribute";
//cfgArray["DeviceCentral_3.0.helpcfg"] = "devicecentral";
//cfgArray["Dreamweaver_11.0.helpcfg"] = "dreamweaver";
//cfgArray["EncoreDVD_5.0.helpcfg"] = "encore";
//cfgArray["ExtensionManager_3.0.helpcfg"] = "extension";
//cfgArray["Fireworks_11.0.helpcfg"] = "fireworks";
//cfgArray["Flash_11.0.helpcfg"] = "flash";
//cfgArray["Flex_4.0.helpcfg"] = "flashbuilder";
//cfgArray["FlashCatalyst_1.0.helpcfg"] = "flashcatalyst";
//cfgArray["Illustrator_15.0.helpcfg"] = "illustrator";
//cfgArray["InCopy_7.0.helpcfg"] = "incopy";
//cfgArray["InDesign_7.0.helpcfg"] = "indesign";
//cfgArray["OnLocation_5.0.helpcfg"] = "onlocation";
//cfgArray["Photoshop_12.0.helpcfg"] = "photoshop";
//cfgArray["PremierePro_5.0.helpcfg"] = "premierepro";

function getLangName() {
    var lang = "en-us";
    var metaElements = document.all ?
            document.all.tags('meta') :
            document.getElementsByTagName ?
            document.getElementsByTagName ('meta') : new Array();
    for (var m = 0; m < metaElements.length; m++) {
        if (metaElements[m].name == "lang") {
            lang = metaElements[m].content;
            break;
        }
    }
    var ptn = /(..)-(..)/;
    if (ptn.test(lang)) {
        var languageCode = lang.replace(ptn, "$1");
        var countryCode = lang.replace(ptn, "$2");
        lang = languageCode + "_" + countryCode.toUpperCase();
    }
    return lang;
}

function getCountryName() {
    var lang = "";
    var metaElements = document.all ?
            document.all.tags('meta') :
            document.getElementsByTagName ?
            document.getElementsByTagName ('meta') : new Array();
    for (var m = 0; m < metaElements.length; m++) {
        if (metaElements[m].name == "lang") {
            lang = metaElements[m].content;
            break;
        }
    }
    var ptn = /(..)-(..)/;
    if ((ptn.test(lang)) && (lang != "en-us")) {
        var countryCode = lang.replace(ptn, "$2");
        return "/" + countryCode;
    }
    return "";
}

if ( (typeof(terms_HELPCFG) != 'undefined')  && (terms_HELPCFG.indexOf(".helpcfg") != -1) ) {
    var stage   = (document.location.href.indexOf(".stage.") != -1) ? 'stage.' : '';
    var baseUrl = 'http://www.' + stage + 'adobe.com';
    var refpage = document.location.href.replace(/#.*$/, '');
	
	if ((!use_robohelp_behavior) && (terms_HELPCFG.length > 0) && (typeof(cfgArray[terms_HELPCFG]) != 'undefined') && (cfgArray[terms_HELPCFG].length > 0)) {
		if (document.getElementById) { // DOM3 = IE5, NS6
			var newHref = baseUrl + getCountryName() + "/support/chc/" + "?helpcfg=http://help." + stage + "adobe.com/HelpCfg/" + getLangName() + "/" + terms_HELPCFG + "&url=" + refpage + "&product=" + cfgArray[terms_HELPCFG];
			var newSrc = baseUrl + getCountryName() + "/support/chc/GetMoreHelpFeatures.png";
			document.getElementById("chcPromo").style.display = "block";
			document.getElementById("chcLink").href = newHref;
			document.getElementById("chcImage").src = newSrc;
		}
	}
}

//-->
</script>



          <div id="minitoc"><div class="t"><div class="b"><div><ul id="minitoc-links"><li><p><a href="#WSc3ff6d0ea77859461172e0811cbec22c24-7cb9"><span class="topictitle1">Sample locking scenarios</span>
</a></p><ul><li><p><a href="#WS7B937590-83E0-4355-8FBA-92CEFE3DEDF6"><span class="topictitle2">Reading and writing a shared variable</span>
</a></p></li><li><p><a href="#WS9DA78438-D348-4265-ABE4-7D38C10EC635"><span class="topictitle2">Ensuring consistency of multiple variables</span>
</a></p></li></ul></li><li><p><a href="#WSc3ff6d0ea77859461172e0811cbec0c35c-7fe0"><span class="topictitle1">Using the cflock tag with write-once variables</span>
</a></p></li><li><p><a href="#WSc3ff6d0ea77859461172e0811cbec0c35c-7fdf"><span class="topictitle1">Using the cflock tag</span>
</a></p><ul><li><p><a href="#WS63DA4B0E-F681-45af-9916-E93A7312FF93"><span class="topictitle2">Lock types</span>
</a></p></li><li><p><a href="#WS14546FE1-D78A-4d31-A79A-AB2E860A9D47"><span class="topictitle2">Lock scopes and names</span>
</a></p></li><li><p><a href="#WS05E2E847-A188-41a5-A6A1-AF0A33AD08D4"><span class="topictitle2">Controlling access to data with the scope attribute</span>
</a></p></li><li><p><a href="#WS32458295-6169-437f-A3D5-D1B5235AA4FA"><span class="topictitle2">Controlling locking access to files and CFX tags with the name attribute</span>
</a></p></li><li><p><a href="#WS6D7A3A85-C0BA-4ee4-9D8A-DEFEF0F56C54"><span class="topictitle2">Controlling and minimizing lock time-outs</span>
</a></p></li></ul></li><li><p><a href="#WSc3ff6d0ea77859461172e0811cbec0c35c-7fc2"><span class="topictitle1">Considering lock granularity</span>
</a></p></li><li><p><a href="#WSc3ff6d0ea77859461172e0811cbec0c35c-7fdc"><span class="topictitle1">Nesting locks and avoiding deadlocks</span>
</a></p><ul><li><p><a href="#WS579FF384-2874-43da-AE0C-B5F121754C90"><span class="topictitle2">Copying shared variables into the Request scope</span>
</a></p></li><li><p><a href="#WS6DB525F0-F8F0-4ee9-A286-DE02016C9A78"><span class="topictitle2">Locking application variables efficiently</span>
</a></p></li></ul></li></ul></div></div></div></div><div><p>The <samp class="codeph"><a href="http://help.adobe.com/en_US/ColdFusion/9.0/CFMLRef/WSc3ff6d0ea77859461172e0811cbec22c24-7f5d.html" target="_self">cflock</a></samp> tag controls simultaneous
access to ColdFusion code. The <samp class="codeph">cflock</samp> tag lets
you do the following:</p>
<ul><li><p>Protect sections of code that access and manipulate
shared data in the Session, Application, and Server scopes, and
in the Request and Variables scopes for applications that use ColdFusion
threads.</p>
</li>
<li><p>Ensure
that file updates do not fail because files are open for writing
by other applications or ColdFusion tags.</p>
</li>
<li><p>Ensure
that applications do not try to simultaneously access ColdFusion extension
tags written using the CFX API that are not thread-safe. This is important
for CFX tags that use shared (global) data structures without protecting
them from simultaneous access (not thread-safe). However, Java CFX
tags can also access shared resources that could become inconsistent
if the CFX tag access is not locked.</p>
</li>
<li><p>Ensure that applications do not try to
simultaneously access databases that are not thread-safe. (This
is not necessary for most database systems.)</p>
</li>
</ul>
<p>ColdFusion is a multi-threaded web application server that can
process multiple page requests at a time. As a result, the server
can attempt to access the same information or resources simultaneously,
as the result of two or more requests. </p>
<p>Although ColdFusion is thread-safe and does not try to modify
a variable simultaneously, it does not ensure the correct order
of access to information. If multiple pages, or multiple invocations
of a page, attempt to write data simultaneously, or read and write
it at the same time, the resulting data can be inconsistent, as
shown in the following <a href="WSc3ff6d0ea77859461172e0811cbec22c24-7cb9.html">Sample locking scenarios</a> section.</p>
<p>Similarly, ColdFusion cannot automatically ensure that two sections
of code do not attempt to access external resources such as files,
databases, or CFX tags that cannot properly handle simultaneous
requests. Nor can ColdFusion ensure that the order of access to
these shared resources is consistent and results in valid data.</p>
<p>By locking code that accesses such resources so that only one
thread can access the resource at a time, you can prevent race conditions.</p>
</div>
<div id="WSc3ff6d0ea77859461172e0811cbec22c24-7cb9" class="nochunk"><a name="WSc3ff6d0ea77859461172e0811cbec22c24-7cb9"><!-- --></a><h2 class="topictitle2">Sample locking scenarios</h2><div><p>The following examples present scenarios in which you need
to lock ColdFusion code. These scenarios show only two of the circumstances
where locking is vital.</p>
</div><div id="WS7B937590-83E0-4355-8FBA-92CEFE3DEDF6" class="nochunk"><a name="WS7B937590-83E0-4355-8FBA-92CEFE3DEDF6"><!-- --></a><h3 class="topictitle3">Reading and writing a shared variable</h3><div><p>If you have an application-wide value, such as a counter
of the total number of tickets sold, you could have code such as
the following on a login page:</p>
<pre>&lt;cfset Application.totalTicketsSold = Application.totalTicketsSold + ticketOrder&gt;</pre>
<p>When ColdFusion executes this code, it performs the following
operations:</p>
<ol><li><p>Retrieves the current value of Application.totalTicketsSold
from temporary storage.</p>
</li>
<li><p>Increments this value.</p>
</li>
<li><p>Stores the result back in the Application scope. </p>
</li>
</ol>
<p>Suppose that ColdFusion processes two ticket orders at approximately
the same time, and that the value of Application.totalTicketsSold
is initially 160. The following sequence might happen: </p>
<ol><li><p>Order 1 reads the total tickets sold as 160.</p>
</li>
<li><p>Order 2 reads the total tickets sold as 160.</p>
</li>
<li><p>Order 1 adds an order of 5 tickets to 160 to get 165.</p>
</li>
<li><p>Order 2 adds an order of 3 tickets to 160 to get 163.</p>
</li>
<li><p>Order 1 saves the value 165 to Application.totalTicketsSold</p>
</li>
<li><p>Order 2 saves the value 163 to Application.totalTicketsSold</p>
</li>
</ol>
<p>The application now has an inaccurate count of the tickets sold,
and is in danger of selling more tickets than the auditorium can
hold.</p>
<p>To prevent this from happening, lock the code that increments
the counter, as follows:</p>
<pre>&lt;cflock scope="Application" timeout="10" type="Exclusive"&gt; 
    &lt;cfset Application.totalTicketsSold = Application.totalTicketsSold + ticketOrder&gt; 
&lt;/cflock&gt;</pre>
<p>The <samp class="codeph">cflock</samp> tag ensures that while ColdFusion
performs the processing in the tag body, no other threads can access
the Application scope. As a result, the second transaction is not
processed until the first one completes. The processing sequence
looks something like the following:</p>
<ol><li><p>Order 1 reaches the lock tag, which gets an Application
scope lock.</p>
</li>
<li><p>Order 1 reads the total tickets sold as 160.</p>
</li>
<li><p>Order 2 reaches the lock tag. Because there is an active
Application scope lock, ColdFusion waits for the lock to free.</p>
</li>
<li><p>Order 1 adds an order of 5 tickets to 160 to get 165.</p>
</li>
<li><p>Order 1 saves the value 165 to Application.totalTicketsSold.</p>
</li>
<li><p>Order 1 exits the lock tag. The Application scope lock is
now free.</p>
</li>
<li><p>Order 2 gets the Application scope lock and can begin processing.</p>
</li>
<li><p>Order 2 reads the total tickets sold as 165.</p>
</li>
<li><p>Order 2 adds an order of 3 tickets to 165 to get 168.</p>
</li>
<li><p>Order 2 saves the value 168 to Application.totalTicketsSold.</p>
</li>
<li><p>Order 2 exits the lock tag, which frees the Application scope
lock. ColdFusion can process another order.</p>
</li>
</ol>
<p>The resulting Application.totalTickesSold value is now correct.</p>
</div></div><div id="WS9DA78438-D348-4265-ABE4-7D38C10EC635" class="nochunk"><a name="WS9DA78438-D348-4265-ABE4-7D38C10EC635"><!-- --></a><h3 class="topictitle3">Ensuring consistency of multiple variables</h3><div><p>Often an application sets multiple shared scope variables
at one time, such as many values submitted by a user on a form.
If the user submits the form, clicks the back button, and then resubmits
the form with different data, the application can end up with a
mixture of data from the two submissions, in much the same manner
as shown in the previous section.</p>
<p>For example, an application stores information about order items
in a Session scope shopping cart. If the user submits an item selection
page with data specifying sage green size 36 shorts, and then resubmits
the item specifying sea blue size 34 shorts, the application can
end up with a mixture of information from the two orders, such as
sage green size 34 shorts.</p>
<p>By placing the code that sets all of the related session variables
in a single <samp class="codeph">cflock</samp> tag, you ensure that all the
variables get set together. In other words, setting all of the variables
becomes an <strong>atomic</strong>, or single, operation. It is like a database
transaction, where everything in the transaction happens, or nothing happens.
In this example, the order details for the first order all get set,
and then they are replaced with the details from the second order.</p>
<p>For more examples of using locking in applications, see <a href="WSc3ff6d0ea77859461172e0811cbec22c24-7cb8.html">Examples of cflock</a>.</p>
</div></div></div>
<div id="WSc3ff6d0ea77859461172e0811cbec0c35c-7fe0" class="nochunk"><a name="WSc3ff6d0ea77859461172e0811cbec0c35c-7fe0"><!-- --></a><h2 class="topictitle2">Using the cflock tag with write-once variables</h2><div><p>You
need not use <samp class="codeph">cflock</samp> when you read a variable or
call a user-defined function name in the Session, Application, or
Server scope if it is set in <i xmlns:fn="http://www.w3.org/2005/xpath-functions" xmlns:fo="http://www.w3.org/1999/XSL/Format" xmlns:xs="http://www.w3.org/2001/XMLSchema">only one place</i> in the application,
and is only read (or called, for a UDF) everywhere else. Such data
is called <i xmlns:fn="http://www.w3.org/2005/xpath-functions" xmlns:fo="http://www.w3.org/1999/XSL/Format" xmlns:xs="http://www.w3.org/2001/XMLSchema">write-once</i>. If you set an Application or Session
scope variable in Application.cfm and never set it on any other
pages, lock the code that sets the variable, but do not have to
lock code on other pages that reads the variable’s value. If you
set the variable in the corresponding start method in Application.cfc (for
example, <samp class="codeph">onApplicationStart</samp> for Application scope
variables), you do not have to lock the code that sets the variable.</p>
<p>However, although leaving code that uses write-once data unlocked
can improve application performance, it also has risks. Ensure that
the variables are written only once. For example, ensure that the
variable is not rewritten if the user refreshes the browser or clicks
a back button. Also, it can be difficult to ensure that you, or
future developers, do not later set the variable in more than one place
in the application.</p>
</div></div>
<div id="WSc3ff6d0ea77859461172e0811cbec0c35c-7fdf" class="nochunk"><a name="WSc3ff6d0ea77859461172e0811cbec0c35c-7fdf"><!-- --></a><h2 class="topictitle2">Using the cflock tag</h2><div><p>The <samp class="codeph"><a href="http://help.adobe.com/en_US/ColdFusion/9.0/CFMLRef/WSc3ff6d0ea77859461172e0811cbec22c24-7f5d.html" target="_self">cflock</a></samp> tag ensures that concurrently
executing requests do not run the same section of code simultaneously
and thus manipulate shared data structures, files, or CFX tags inconsistently.
It is important to remember that <samp class="codeph">cflock</samp> protects
code sections that access or set data, <i xmlns:fn="http://www.w3.org/2005/xpath-functions" xmlns:fo="http://www.w3.org/1999/XSL/Format" xmlns:xs="http://www.w3.org/2001/XMLSchema">not</i> the variables
themselves.</p>
<p>You protect access to code by surrounding it in a <samp class="codeph">cflock</samp> tag;
for example:</p>
<pre>&lt;cflock scope="Application" timeout="10" type="Exclusive"&gt; 
    &lt;cfif not IsDefined("Application.number")&gt; 
        &lt;cfset Application.number = 1&gt; 
    &lt;/cfif&gt; 
&lt;/cflock&gt;</pre>
</div><div id="WS63DA4B0E-F681-45af-9916-E93A7312FF93" class="nochunk"><a name="WS63DA4B0E-F681-45af-9916-E93A7312FF93"><!-- --></a><h3 class="topictitle3">Lock types</h3><div><p>The <samp class="codeph"><a href="http://help.adobe.com/en_US/ColdFusion/9.0/CFMLRef/WSc3ff6d0ea77859461172e0811cbec22c24-7f5d.html" target="_self">cflock</a></samp> tag offers two modes
of locking, specified by the <samp class="codeph">type</samp> attribute: </p>
<dl><dt class="dlterm">Exclusive locks (the default lock type)</dt>
<dd xmlns:fn="http://www.w3.org/2005/xpath-functions" xmlns:fo="http://www.w3.org/1999/XSL/Format" xmlns:xs="http://www.w3.org/2001/XMLSchema">Allow only one request to process the locked
code. No other requests can run code inside the tag while a request
has an exclusive lock.<p>Enclose all code that creates or modifies
session, application, or server variables in exclusive <samp class="codeph">cflock</samp> tags.</p>
</dd><p class="dlseparator"></p><dt class="dlterm">Read-only locks</dt>
<dd xmlns:fn="http://www.w3.org/2005/xpath-functions" xmlns:fo="http://www.w3.org/1999/XSL/Format" xmlns:xs="http://www.w3.org/2001/XMLSchema">Allow multiple requests to execute concurrently
if no exclusive locks with the same scope or name are executing.
No requests can run code inside the tag while a request has an exclusive
lock.<p>Enclose code that only reads or tests session, application,
or server variables in read-only <samp class="codeph">cflock</samp> tags. You
specify a read-only lock by setting the <samp class="codeph">type="readOnly"</samp> attribute
in the <samp class="codeph">cflock</samp> tag, for example:</p>
<pre>&lt;cflock scope="Application" timeout="10" type="readOnly"&gt; 
    &lt;cfif IsDefined("Application.dailyMessage")&gt; 
        &lt;cfoutput&gt;#Application.dailyMessage#&lt;br&gt;&lt;/cfoutput&gt; 
    &lt;/cfif&gt; 
&lt;/cflock&gt;</pre>
<p>Although ColdFusion does not prevent
you from setting shared variables inside read-only lock tag, doing
so loses the advantages of locking. As a result, be careful not
to set any session, application, or server variables inside a read-only <samp class="codeph">cflock</samp> tag
body. </p>
<div class="note"><span class="notetitle">Note:  </span>You cannot upgrade or downgrade a
lock from one type to another. In other words, do not nest an exclusive
lock in a read-only lock of the same name or scope; the exclusive
lock will always time out. Also, do not nest a read-only lock inside
an exclusive lock with the same name or scope; doing so has no effect.</div>
</dd><p class="dlseparator"></p></dl>
</div></div><div id="WS14546FE1-D78A-4d31-A79A-AB2E860A9D47" class="nochunk"><a name="WS14546FE1-D78A-4d31-A79A-AB2E860A9D47"><!-- --></a><h3 class="topictitle3">Lock scopes and names</h3><div><p>The <samp class="codeph"><a href="http://help.adobe.com/en_US/ColdFusion/9.0/CFMLRef/WSc3ff6d0ea77859461172e0811cbec22c24-7f5d.html" target="_self">cflock</a></samp> tag prevents simultaneous
access to sections of code, not to variables. If you have two sections
of code that access the same variable, they must be synchronized
to prevent them from running simultaneously. You do this by identifying
the locks with the same <samp class="codeph">scope</samp> or <samp class="codeph">name</samp> attributes.</p>
<div class="note"><span class="notetitle">Note:  </span>ColdFusion does not require you to identify
exclusive locks. If you omit the identifier, the lock is anonymous
and you cannot synchronize the code in the <samp class="codeph">cflock</samp> tag
block with any other code. Anonymous locks do not cause errors when they
protect a resource that is used in a single code block, but they
are bad programming practice. You must always identify read-only
locks.</div>
</div></div><div id="WS05E2E847-A188-41a5-A6A1-AF0A33AD08D4" class="nochunk"><a name="WS05E2E847-A188-41a5-A6A1-AF0A33AD08D4"><!-- --></a><h3 class="topictitle3">Controlling access to data with the scope attribute</h3><div><p>When the code that you are locking
accesses session, application, or server variables, synchronize
access by using the <samp class="codeph">cflock</samp><samp class="codeph">scope</samp> attribute. </p>
<p>You can set the attribute to any of the following values:</p>

<div class="tablenoborder"><table border="1" cellpadding="4" cellspacing="0"><thead align="left"><tr><th valign="top" width="NaN%" id="d17e33264"><p>Scope</p>
</th>
<th valign="top" width="NaN%" id="d17e33267"><p>Meaning</p>
</th>
</tr>
</thead>
<tbody><tr><td valign="top" width="NaN%" headers="d17e33264 "><p>Server</p>
</td>
<td valign="top" width="NaN%" headers="d17e33267 "><p>All code sections with this attribute on
the server share a single lock.</p>
</td>
</tr>
<tr><td valign="top" width="NaN%" headers="d17e33264 "><p>Application</p>
</td>
<td valign="top" width="NaN%" headers="d17e33267 "><p>All code sections with this attribute in
the same application share a single lock.</p>
</td>
</tr>
<tr><td valign="top" width="NaN%" headers="d17e33264 "><p>Session</p>
</td>
<td valign="top" width="NaN%" headers="d17e33267 "><p>All code sections with this attribute that
run in the same session of an application share a single lock.</p>
</td>
</tr>
<tr><td valign="top" width="NaN%" headers="d17e33264 "><p>Request</p>
</td>
<td valign="top" width="NaN%" headers="d17e33267 "><p>All code sections with this attribute that
run in the same request share a single lock. You use this scope
only if your application uses the <samp class="codeph">cfthread</samp> tag
to create multiple threads in a single request. Locking the Request
scope also locks access to Variables scope data. For more information
on locking the Request scope, see <a href="WSc3ff6d0ea77859461172e0811cbec22c24-7cc7.html">Locking thread data and resource access</a>.</p>
</td>
</tr>
</tbody>
</table>
</div>
<p>If multiple code sections share a lock, the following rules apply:</p>
<ul><li><p>When code is running in a <samp class="codeph">cflock</samp> tag
block with the <samp class="codeph">type</samp> attribute set to <samp class="codeph">Exclusive</samp>,
code in <samp class="codeph">cflock</samp> tag blocks with the same <samp class="codeph">scope</samp> attribute
is not allowed to run. They wait until the code with the exclusive
lock completes.</p>
</li>
<li><p>When code in a <samp class="codeph">cflock</samp> tag block with the
type <samp class="codeph">readOnly</samp> is running, code in other <samp class="codeph">cflock</samp> tag
blocks with the same <samp class="codeph">scope</samp> attribute and the <samp class="codeph">readOnly</samp><samp class="codeph">type</samp> attribute
can run, but any blocks with the same <samp class="codeph">scope</samp> attribute
and an <samp class="codeph">Exclusive</samp> type cannot run and must wait
until all code with the read-only lock completes. However, if a
read-only lock is active and code with an exclusive lock with the
same scope or name is waiting to execute, read-only requests using
the same scope or name that are made after the exclusive request
is queued must wait until code with the exclusive lock executes
and completes.</p>
</li>
</ul>
</div></div><div id="WS32458295-6169-437f-A3D5-D1B5235AA4FA" class="nochunk"><a name="WS32458295-6169-437f-A3D5-D1B5235AA4FA"><!-- --></a><h3 class="topictitle3">Controlling locking access to files and CFX tags with the name attribute</h3><div><p>The <samp class="codeph">cflock</samp><samp class="codeph">name</samp> attribute
provides a second way to identify locks. Use this attribute when
you use locks to protect code that manges file access or calls non-thread-safe
CFX code.</p>
<p>When you use the <samp class="codeph">name</samp> attribute, specify the
same name for each section of code that accesses a specific file
or a specific CFX tag.</p>
</div></div><div id="WS6D7A3A85-C0BA-4ee4-9D8A-DEFEF0F56C54" class="nochunk"><a name="WS6D7A3A85-C0BA-4ee4-9D8A-DEFEF0F56C54"><!-- --></a><h3 class="topictitle3">Controlling and minimizing lock time-outs</h3><div><p>Include
a <samp class="codeph">timeout</samp> attribute in your <samp class="codeph"><a href="http://help.adobe.com/en_US/ColdFusion/9.0/CFMLRef/WSc3ff6d0ea77859461172e0811cbec22c24-7f5d.html" target="_self">cflock</a></samp> tag. The <samp class="codeph">timeout</samp> attribute specifies
the maximum time, in seconds, to wait to obtain the lock if it is
not available. By default, if the lock does not become available
within the time-out period, ColdFusion generates a Lock type exception
error, which you can handle using <samp class="codeph"><a href="http://help.adobe.com/en_US/ColdFusion/9.0/CFMLRef/WSc3ff6d0ea77859461172e0811cbec22c24-7ec6.html" target="_self">cftry</a></samp> and <samp class="codeph"><a href="http://help.adobe.com/en_US/ColdFusion/9.0/CFMLRef/WSc3ff6d0ea77859461172e0811cbec22c24-7ec5.html" target="_self">cfcatch</a></samp> tags.</p>
<p>If you set the <samp class="codeph">cflock</samp><samp class="codeph">throwOnTimeout</samp> attribute
to No, processing continues after the time-out at the line after
the <samp class="codeph">&lt;/cflock&gt;</samp> end tag. Code in the <samp class="codeph">cflock</samp> tag
body does not run if the time-out occurs before ColdFusion can acquire
the lock. Therefore, never use the <samp class="codeph">throwOnTimeout</samp> attribute
for CFML that must run.</p>
<p>Normally, it does not take more than a few seconds to obtain
a lock. Very large time-outs can block request threads for long
periods of time and radically decrease throughput. Always use the
smallest time-out value that does not result in a significant number
of time-outs.</p>
<p>To prevent unnecessary time-outs, lock the minimum amount of
code possible. Whenever possible, lock only code that sets or reads
variables, not business logic or database queries. One useful technique
is to do the following:</p>
<ol><li><p>Perform a time-consuming activity outside a <samp class="codeph">cflock</samp> tag</p>
</li>
<li><p>Assign the result to a Variables scope variable</p>
</li>
<li><p>Assign the Variables scope variable’s value to a shared scope
variable inside a <samp class="codeph">cflock</samp> block.</p>
</li>
</ol>
<p>For example, if you want to assign the results of a query to
a session variable, first get the query results using a Variables
scope variable in unlocked code. Then, assign the query results
to a session variable inside a locked code section. The following
code shows this technique: </p>
<pre>&lt;cfquery name="Variables.qUser" datasource="#request.dsn#"&gt; 
    SELECT FirstName, LastName 
    FROM Users 
    WHERE UserID = #request.UserID# 
&lt;/cfquery&gt; 
&lt;cflock scope="Session" timeout="5" type="exclusive"&gt; 
    &lt;cfset Session.qUser = Variables.qUser&gt; 
&lt;/cflock&gt;</pre>
</div></div></div>
<div id="WSc3ff6d0ea77859461172e0811cbec0c35c-7fc2" class="nochunk"><a name="WSc3ff6d0ea77859461172e0811cbec0c35c-7fc2"><!-- --></a><h2 class="topictitle2">Considering lock granularity</h2><div><p>When
you design your locking strategy, consider whether you should have multiple
locks containing small amounts of code or few locks with larger
blocks of code. There is no simple rule for making such a decision,
and you might do performance testing with different options to help
make your decision. However, consider the following issues:</p>
<ul><li><p>If the code block is larger, ColdFusion spends more time
inside the block, which can increase the number of times an application
waits for the lock to released.</p>
</li>
<li><p>Each lock requires processor time. The more locks you have,
the more processor time is spent on locking code.</p>
</li>
</ul>
</div></div>
<div id="WSc3ff6d0ea77859461172e0811cbec0c35c-7fdc" class="nochunk"><a name="WSc3ff6d0ea77859461172e0811cbec0c35c-7fdc"><!-- --></a><h2 class="topictitle2">Nesting locks and avoiding deadlocks</h2><div><p>Inconsistent
nesting of <samp class="codeph"><a href="http://help.adobe.com/en_US/ColdFusion/9.0/CFMLRef/WSc3ff6d0ea77859461172e0811cbec22c24-7f5d.html" target="_self">cflock</a></samp> tags and inconsistent
naming of locks can cause deadlocks (blocked code). If you are nesting
locks, you must consistently nest <samp class="codeph">cflock</samp> tags in
the same order and use consistent lock scopes (or names).</p>
<p>A <i xmlns:fn="http://www.w3.org/2005/xpath-functions" xmlns:fo="http://www.w3.org/1999/XSL/Format" xmlns:xs="http://www.w3.org/2001/XMLSchema">deadlock</i> is a state in which no request can execute
the locked section of the page. All requests to the protected section
of the page are blocked until there is a time-out. The following
table shows one scenario that would cause a deadlock:</p>

<div class="tablenoborder"><table border="1" cellpadding="4" cellspacing="0"><thead align="left"><tr><th valign="top" width="NaN%" id="d17e33478"><p>User 1</p>
</th>
<th valign="top" width="NaN%" id="d17e33481"><p>User 2</p>
</th>
</tr>
</thead>
<tbody><tr><td valign="top" width="NaN%" headers="d17e33478 "><p>Locks the Session scope.</p>
</td>
<td valign="top" width="NaN%" headers="d17e33481 "><p>Locks the Application scope.</p>
</td>
</tr>
<tr><td valign="top" width="NaN%" headers="d17e33478 "><p>Tries to lock the Application scope, but
the Application scope is already locked by User 2.</p>
</td>
<td valign="top" width="NaN%" headers="d17e33481 "><p>Tries to lock the Session scope, but the
Session scope is already locked by User 1.</p>
</td>
</tr>
</tbody>
</table>
</div>
<p>Neither user’s request can proceed, because it is waiting for
the other to complete. The two are deadlocked.</p>
<p>Once a deadlock occurs, neither of the users can do anything
to break the deadlock, because the execution of their requests is
blocked until the deadlock is resolved by a lock time-out.</p>
<p>You can also cause deadlocks if you nest locks of different types.
An example of this is nesting an exclusive lock inside a read-only
lock of the same scope or same name.</p>
<p>To
avoid a deadlock, lock code sections in a well-specified order,
and name the locks consistently. In particular, to lock access to
the Server, Application, and Session scopes, do so in the following
order:</p>
<ol><li><p>Lock the Session scope. In the <samp class="codeph">cflock</samp> tag,
specify <samp class="codeph">scope="Session"</samp>.</p>
</li>
<li><p>Lock the Application scope. In the <samp class="codeph">cflock</samp> tag,
specify <samp class="codeph">scope="Application"</samp>.</p>
</li>
<li><p>Lock the Server scope. In the <samp class="codeph">cflock</samp> tag,
specify <samp class="codeph">scope="Server"</samp>.</p>
</li>
<li><p>Unlock the Server scope.</p>
</li>
<li><p>Unlock the Application scope.</p>
</li>
<li><p>Unlock the Session scope.</p>
</li>
</ol>
<div class="note"><span class="notetitle">Note:  </span>You can skip any pair of lock and unlock steps
in the preceding list if you do not need to lock a particular scope.
For example, you can omit steps 3 and 4 if you do not need to lock
the Server scope.</div>
</div><div id="WS579FF384-2874-43da-AE0C-B5F121754C90" class="nochunk"><a name="WS579FF384-2874-43da-AE0C-B5F121754C90"><!-- --></a><h3 class="topictitle3">Copying shared variables into the Request scope</h3><div><p>You can avoid locking some shared-scope variables multiple
times during a request by doing the following:</p>
<ol><li><p>Copy the shared-scope variables into the Request scope
in code with an exclusive lock in the Application.cfc <samp class="codeph">onRequestStart</samp> method
or the Application.cfm page.</p>
</li>
<li><p>Use the Request scope variables on your ColdFusion pages
for the duration of the request.</p>
</li>
<li><p>Copy the variables back to the shared scope in code with
an exclusive lock in the Application.cfc <samp class="codeph">onRequestEnd</samp> method
on the OnRequestEnd.cfm page.</p>
</li>
</ol>
<p>With this technique the “last request wins.” For example, if
two requests run simultaneously, and both requests change the values
of data that was copied from the shared scope, the data from the
last request to finish is saved in the shared scope, and the data
from the previous request is not saved.</p>
</div></div><div id="WS6DB525F0-F8F0-4ee9-A286-DE02016C9A78" class="nochunk"><a name="WS6DB525F0-F8F0-4ee9-A286-DE02016C9A78"><!-- --></a><h3 class="topictitle3">Locking application variables efficiently</h3><div><p>The need to lock application variables can reduce server
performance, because all requests that use Application scope variables
must wait on a single lock. This issue is a problem even for write-once
read-many variables, because you still must ensure that the variable
exists, and possibly set the value before you can read it.</p>
<p>You can minimize this problem by using a technique such as the
following to test for the existence of application variables and
set them if they do not exist:</p>
<ol><li><p>Use an Application scope flag variable to indicate if
the variable or variables are initialized. In a read-only lock,
check for the existence of the flag, and assign the result to a
local variable.</p>
</li>
<li><p>Outside the <samp class="codeph"><a href="http://help.adobe.com/en_US/ColdFusion/9.0/CFMLRef/WSc3ff6d0ea77859461172e0811cbec22c24-7f5d.html" target="_self">cflock</a></samp> bock, test the value
of the local variable</p>
</li>
<li><p>If it the local variable indicates that the application variables
are not initialized, get an exclusive Application scope lock.</p>
</li>
<li><p>Inside the lock, again test the Application scope flag, to
make sure that another page has not set the variables between step
one and step four.</p>
</li>
<li><p>If the variables are still not set, set them and set the
Application scope flag to true.</p>
</li>
<li><p>Release the exclusive lock.</p>
</li>
</ol>
<p>The following code shows this technique:</p>
<pre>&lt;!--- Initialize local flag to false. ---&gt; 
&lt;cfset app_is_initialized = False&gt; 
&lt;!--- Get a readonly lock ---&gt; 
&lt;cflock scope="application" type="readonly"&gt; 
    &lt;!--- read init flag and store it in local variable ---&gt; 
    &lt;cfset app_is_initialized = IsDefined("APPLICATION.initialized")&gt; 
&lt;/cflock&gt; 
&lt;!--- Check the local flag ---&gt; 
&lt;cfif not app_is_initialized &gt; 
&lt;!--- Not initialized yet, get exclusive lock to write scope ---&gt; 
    &lt;cflock scope="application" type="exclusive"&gt; 
        &lt;!--- Check nonlocal flag since multiple requests could get to the 
                exclusive lock ---&gt; 
        &lt;cfif not IsDefined("APPLICATION.initialized") &gt; 
            &lt;!--- Do initializations ---&gt; 
            &lt;cfset APPLICATION.varible1 = someValue &gt; 
             ...  
            &lt;!--- Set the Application scope initialization flag ---&gt; 
            &lt;cfset APPLICATION.initialized = "yes"&gt; 
        &lt;/cfif&gt; 
    &lt;/cflock&gt; 
&lt;/cfif&gt;</pre>
</div></div></div>


<!-- BEGIN USER PREFERENCES -->
          <div id="userprefs">
          </div>
<!-- END USER PREFERENCES -->

          <div id="related">
            
            
            <div class="separator"><a href="#top"><img src="images/BTT.jpg" /></a>&#160;</div>
          </div>
          <div id="footer">
<!-- BEGIN IONCOMMENTS -->
            <div id="ionComHere">
            </div>
<!-- END IONCOMMENTS -->


            <p id="creativecommons"><a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" id="creativecommons_text"><img id="creativecommons_img" src="images/CC.png" alt="This work is licensed under a Creative Commons Attribution-Noncommercial-Share Alike 3.0 Unported License" /></a>&nbsp;Twitter™ and Facebook posts are not covered under the terms of Creative Commons.</p>
          </div>
</td>
<td width="10px"></td>
<td id="inner_rightcolumn">

</td></tr></table>
      </div>
<!-- BEGIN BREADCRUMBS -->
      <div id="breadcrumb">
        
<ul class="navigation"><li class="prev"><a accesskey="p" class="prev" href="WSc3ff6d0ea77859461172e0811cbec0c35c-7fdb.html" title="Using server variables"><img src="images/blank.gif" alt="Previous" width="17" height="17" /></a></li><li class="next"><a accesskey="n" class="next" href="WSc3ff6d0ea77859461172e0811cbec22c24-7cb8.html" title="Examples of cflock"><img src="images/blank.gif" alt="Next" width="17" height="17" /></a></li></ul><div class="hierarchy" id="hierarchy"><a href="WSf01dbd23413dda0e-446b5201205757ce2b-8000.html"><b>Home</b></a> / <a href="WSf01dbd23413dda0e-446b5201205757ce2b-8000.html"><b>Developing&#160;ColdFusion 9 Applications</b></a> / <a href="WS8f0cc78011fffa71-ea0996f11cdae56045-8000.html"><b>Developing CFML Applications</b></a> 
      / <a href="WSc3ff6d0ea77859461172e0811cbec22c24-7fd4.html"><b>Using Persistent Data and Locking</b></a> 
     </div>

      </div>
<!-- END BREADCRUMBS -->
<!-- END CONTENT WRAPPER -->

</td>
<td id="col3">
    <div>
        <img src="images/adobe-lq.png" />
    </div>
</td>
</tr>
</table>
    </div>
<!-- END PAGE CONTENT WRAPPER -->
<script type="text/javascript">
<!--[CDATA[
scrollToNameAnchor();
// ]]-->
</script> 
<!--
    Description:
    This file generates the link to product support in the top right corner
-->

<style>
#menutop{
    position:absolute;
    top:4px;
    right:24px;
    width:auto;    
    font-size:11px;
    color:#fff;
    text-align:right;
}
#menutop a{
    color:#fff;
}
#menutop a:hover{
        text-decoration:underline;
}
</style>  
  
  
  
  
<div id="productmenu">
<!--googleoff: index-->
  <div id="menutop">


<script language=javascript type='text/javascript'>
    // darken menu text for products with light backgrounds
    var path = document.location.href.toLowerCase();
    if (path.indexOf("/acrobat/")           	> 0 ||
        path.indexOf("/acrobat.com/")       	> 0 ||
        path.indexOf("/acrobatConnectPro/") 	> 0 ||
        path.indexOf("/connect/")           	> 0 ||
        path.indexOf("/livecycledataserviceses/") > 0 ||
        path.indexOf("/muse/")         	> 0 ||
	path.indexOf("/presenter/")         	> 0 ||
        path.indexOf("/scene7/")            	> 0 ||
        path.indexOf("/flashmediaserver/")  	> 0 ||
        path.indexOf("/wave/")              	> 0 )
    {
        document.write('<style>#menutop a{color:#505050}</style>');
    }
    if (typeof('terms_AHV_PRODUCT_SUPPORT') != "undefined" && ! use_robohelp_behavior ){      
        if (path.indexOf("/muse/") > -1 ){
            var supportlink = '<a href="http://muse.adobe.com/support.html">'+terms_AHV_PRODUCT_SUPPORT+'</a>';
        }else{
            var supportlink = '<a href="http://adobe.com/support">'+terms_AHV_PRODUCT_SUPPORT+'</a>';
        }
        document.write( supportlink );
     }

</script> 

  </div>
<!--googleon: index-->
</div>



<style>
#online-privacy-policy{ 
    margin:10px 40px; 
    font-size:11px;
}
</style>

<p id="online-privacy-policy">
<script language="javascript">
var pageLoc = "en_US";
var metaElements = document.all ?
document.all.tags('meta') :
document.getElementsByTagName ?
document.getElementsByTagName ('meta') : new Array();
for (var m = 0; m < metaElements.length; m++) {
	if (metaElements[m].name == "lang") {
		pageLoc = metaElements[m].content;
		break;
	}
}
var ptn = /(..)-(..)/;
if (ptn.test(pageLoc)) {
	var languageCode = pageLoc.replace(ptn, "$1");
	var countryCode = pageLoc.replace(ptn, "$2");
	pageLoc = languageCode + "_" + countryCode.toUpperCase();
}

var policyLoc = "en_US";
var policyText = "Online Privacy Policy";
var policyPath = "";
var policyArray=[
"da_DK", "Online fortrolighedserklæring",
"de_DE", "Online-Datenschutzrichtlinie",
"es_ES", "Política de confidencialidad en línea",
"fi_FI", "Yksityisyyttä koskeva Online-toimintaohjelma",
"fr_FR", "Confidentialité et sécurité",
"it_IT", "Informativa sulla privacy online",
"ja_JP", "プライバシーポリシー",
"ko_KR", "Adobe 온라인 개인정보 보호정책",
"pt_BR", "Política de Confidencialidade On-line", 
"zh_CN", "在线隐私政策",
"zh_TW", "線上隱私政策"
];
var legalLoc = "en_US";
var legalText = "Legal Notices";
var legalPath = legalLoc;
var legalArray=[
"ar_AE", "إشعارات قانونية",
"bg_BG", "Юридически бележки",
"cs_CZ", "Právní upozornění",
"da_DK", "Juridiske meddelelser",
"de_DE", "Rechtliche Hinweise",
"el_GR", "Σημειώσεις νομικού περιεχομένου",
"es_ES", "Avisos legales",
"et_EE", "Juriidilised teated",
"fi_FI", "Lakisääteiset ilmoitukset",
"fr_FR", "Mentions légales",
"he_IL", "הצהרות משפטיות",
"hr_HR", "Pravne napomene",
"hu_HU", "Jogi közlemények",
"it_IT", "Informazioni legali",
"ja_JP", "法律上の注意",
"ko_KR", "법적 고지 사항",
"lt_LT", "Teisinės pastabos",
"lv_LV", "Juridisks paziņojums",
"nb_NO", "Juridiske merknader",
"nl_NL", "Juridische kennisgevingen",
"pl_PL", "Informacje prawne",
"pt_BR", "Aspectos jurídicos",
"ro_RO", "Prevederi legale",
"ru_RU", "Юридическая информация",
"sk_SK", "Právne upozornenie",
"sl_SI", "Pravni pouk",
"sv_SE", "Upphovsrätt",
"tr_TR", "Yasal uyarılar",
"uk_UA", "Юридична інформація",
"zh_CN", "法律声明",
"zh_TW", "法律注意事項"
];

ruPolicy = "http://www.adobe.com/ru/misc/privacy.html";
trPolicy = "http://www.adobe.com/tr/misc/privacy.html";

// Bug 2846992: LOC: RUS, TUR: The link to "Online Privacy Policy" should include language, currently it is not appearing.
if (pageLoc == "ru_RU") {
	policyPath = "ru";
}
else if (pageLoc == "tr_TR") {
	policyPath = "tr";
}
for (var i = 0; i < policyArray.length; i+=2) {
	if (pageLoc == policyArray[i]) {
		policyLoc = pageLoc;
		policyText = policyArray[i+1];
		var ptn = /(..)_(..)/;
		if (ptn.test(policyLoc)) {
			var countryCode = policyLoc.replace(ptn, "$2");
			policyPath = countryCode.toLowerCase();
		}
		break;
	}
}

for (var i = 0; i < legalArray.length; i+=2) {
	if (pageLoc == legalArray[i]) {
		legalLoc = pageLoc;
		legalText = legalArray[i+1];
		legalPath = legalLoc;
		break;
	}
}
if(agt.indexOf("community help client") > -1 ){
	document.write('<a href="/'+legalPath+'/legalnotices/index.html">'+legalText+'<\/a>');
	document.write(' | ');
	document.write('<a href="http://www.adobe.com/'+policyPath+'/misc/privacy.html">'+policyText+'<\/a>');
}else{
	//Open the privacy policy in a new window
	document.write('<a target="_blank" href="/'+legalPath+'/legalnotices/index.html">'+legalText+'<\/a>');
	document.write(' | ');
	document.write('<a target="_blank" href="http://www.adobe.com/'+policyPath+'/misc/privacy.html">'+policyText+'<\/a>');
} 
</script>
</p>



<!-- localfooter.ssi -->

<script type="text/javascript">
    var debug = (top.location.href.indexOf("debug=true") > -1);
</script>

<script language="javascript">
document.write('<scr'+'ipt ' +
               'src="/en_US/ssi/_pod.js" ' +
               'language="javascript" ' +
               'charset="UTF-8"> ' +
               '</scr'+'ipt>');
</script>


<script type="text/javascript">
//
//  Ethnio survey code
//
/*          DocumentID      EthnioID */
/*          -------------   -------- */
var ethnio=["/en_US/flash/cs/using/WSb03e830bd6f770ee6664507612436d7dede-8000.html", "87462",
            "/en_US/creativesuite/cs/using/WSe851854fd1e0856a-4b08a77612477f69f15-8000.html",  "10441",
            "/en_US/dreamweaver/cs/using/WSEE4C0148-A6F4-4bf5-9DEF-CE06AB026214a.html",  "57412"
 
    ];
                        
    for ( var i = 0; i < ethnio.length ; i = i+2 ){
        if ( document.location.href.indexOf( ethnio[i] ) > -1 ){ 
            var headID = document.getElementsByTagName("head")[0];         
            var ethnioScript = document.createElement('script');
            ethnioScript.type = 'text/javascript';
            ethnioScript.src = 'http://ethn.io/remotes/' + ethnio[i+1];        
            if ( debug ){
                alert ("Using Ethnio script: " + ethnioScript.src );
            }else{
                headID.appendChild(ethnioScript);
            }
        }
    }
</script>



<div style="display: none;">
<!-- SiteCatalyst -->
<script language="JavaScript" type="text/javascript"><!--
var s_code=' ';
var s_docHost = window.location.hostname.toLowerCase();
var s_docURL = window.location.pathname.toLowerCase();
var scJsHost = (("https:" == document.location.protocol) ? "https://www.adobe.com" : "http://wwwimages.adobe.com");
if (s_docHost.indexOf(".corp.adobe") != -1 || s_docHost.indexOf("stage.") != -1 || s_docHost.indexOf(".dev.adobe") != -1 || s_docHost.indexOf("staging.") != -1) scJsHost="";
document.write(unescape("%3Cscript src='" + scJsHost + "/uber/js/omniture_s_code.js' type='text/javascript'%3E%3C/script%3E"));
//--></script>
<script type="text/javascript"><!--
var s_accountName;
s_server="www.adobe.com static content pages";
if (!window.s_account) s_accountName="mxmacromedia";
else s_accountName=window.s_account;

if (window.s_docURL.indexOf("/designcenter/") != -1)
  s_channel="Adobe Design Center";	
else if ((window.s_docHost.indexOf("labs.adobe") != -1) ||
(window.s_docHost.indexOf("labs-staging.") != -1))
  s_channel="Labs";
else if (window.s_docHost.indexOf("help.adobe.com") != -1) {
  s_channel="Support Help.adobe.com";
  if (window.s_docURL.indexOf("/en_us/") == -1) {
    s_docURLArray=s_docURL.split('/');
    s_pageName="http://help.adobe.com/"+s_docURLArray[1]+"/"+ s_docURLArray[2]+"/"+s_docURLArray[3];
    s_prop23="http://help.adobe.com"+window.location.pathname;
  }
}
else if (window.s_docHost.indexOf("kb2.adobe.com") != -1) {
  s_channel="Support Knowledgebase";
  s_prop23="http://kb2.adobe.com"+s_docURL+":";
  if (typeof(omtrProductList) != 'undefined' && omtrProductList.length > 0)
 {
    s_prop23=s_prop23+omtrProductList;
  }
}
else if (window.s_docHost.indexOf("resellers.adobe.com") != -1) {
		var s_pageName=document.getElementsByTagName("title")[0].text;
}

if (!window.scMMInclude) {
	var s_wd=window,s_tm=new Date;
	if(s_code!=' '){
		s_code=s_dc(s_accountName);
		if(s_code)document.write(s_code)
	} 
} else {
	s_wds(s_accountName);s_ca(s_accountName); 
}	

function sendAnalyticsEvent(str){var ns=s_accountName;if(str!=null)ns+=","+str;void(s_gs(ns));}
function sendLinkEvent(accnt,lnkname,type){
accnt=s_accountName;s_linkType=type;s_lnk=true;s_linkName=lnkname;void(s_gs(accnt));}
//--></script>
<noscript><img src="http://stats.adobe.com/b/ss/mxmacromedia/1/H.15-XELvs/0?pageName=http%3A//www.adobe.com%3A%20noscript&ch=http%3A//www.adobe.com%3A%20noscript&g=http%3A//www.adobe.com" height="1" width="1" border="0" alt="" /></noscript>
<!-- End SiteCatalyst -->
</div>

<script language="JavaScript" type="text/javascript">//<![CDATA[
var scJsHost = (("https:" == document.location.protocol) ? "https://www.adobe.com" : "http://wwwimages.adobe.com");
document.write(unescape("%3Cscript src='" + scJsHost + "/uber/js/atm/s_code_www.js' type='text/javascript'%3E%3C/script%3E"));
//]]></script>
<script type="text/javascript">//<![CDATA[
if(s_adobe){	
	s_adobe.server="www.adobe.com Static Content pages";
	/* Set pageName */
	s_adobe.s_URL="adobe.com"+((location.pathname.charAt(0)=='/')?location.pathname:'/'+location.pathname);
	if (s_adobe.s_URL.substring(s_adobe.s_URL.lastIndexOf('/')+1)=="") s_adobe.s_URL=s_adobe.s_URL+"index.html";
	s_adobe.s_URLSplit=s_adobe.s_URL.split("/");
	s_adobe.pageName=s_adobe.s_URLSplit.join(":");

	/* Set prop4 to language-locale */
	var s_meta=document.getElementsByTagName('meta'); 
      for (i=0; i<s_meta.length; i++) { 
        if (s_meta[i].getAttribute("http-equiv") == "Content-Language") { 
          s_adobe.prop4=s_meta[i].getAttribute("content"); 
	    s_adobe.prop4=s_adobe.prop4.replace(/\s+/g,'');
        } 
      } 
	s_adobe.t()
}
//]]></script>








  </body>
</html>